"""
Simple To-Do List Manager
-------------------------

Features:
- Add tasks (with title, due date, priority)
- View all tasks (sorted by due date)
- View tasks by status (pending / done)
- Mark tasks as complete
- Delete tasks
- Save tasks to a text file and load them on startup

Data used for each task:
[title, due_date, priority, status]

Only basic Python features are used:
- variables, input/output
- if / elif / else
- while and for loops
- lists and strings
- functions (def, parameters, return)
- file handling (open, read, write)
- simple exception handling (try/except)
"""

# ---------------------------
# Helper functions for input
# ---------------------------

def get_non_empty_title():
    """Ask the user for a task title and make sure it is not empty."""
    while True:
        title = input("Enter task title: ").strip()
        if title == "":
            print("Title cannot be empty. Please try again.")
        elif "|" in title:
            # The '|' character is used as a separator in the file
            print("Please do not use the '|' character in the title.")
        else:
            return title


def get_valid_date():
    """
    Ask the user for a due date in the format YYYY-MM-DD.
    The function only checks the format, not if the date is a real calendar date.
    The user can leave it empty to skip the date.
    """
    while True:
        date_str = input("Enter due date (YYYY-MM-DD, or press Enter for no date): ").strip()

        if date_str == "":
            return "no date"

        # Check basic format: 10 characters, positions 4 and 7 are '-', others are digits
        if len(date_str) == 10 \
           and date_str[4] == "-" and date_str[7] == "-" \
           and date_str[:4].isdigit() and date_str[5:7].isdigit() and date_str[8:].isdigit():
            return date_str
        else:
            print("Invalid date format. Please use YYYY-MM-DD, e.g. 2025-12-31.")


def get_valid_priority():
    """
    Ask the user for a priority and only accept: low, medium, high.
    """
    while True:
        priority = input("Priority (low/medium/high): ").strip().lower()
        if priority in ("low", "medium", "high"):
            return priority
        else:
            print("Please enter 'low', 'medium' or 'high'.")


def get_valid_status():
    """Ask the user which status they want to view: pending or done."""
    while True:
        status = input("Show tasks with status (pending/done): ").strip().lower()
        if status in ("pending", "done"):
            return status
        else:
            print("Please enter 'pending' or 'done'.")


def get_valid_task_index(tasks, action_text):
    """
    Ask the user for a task number (1..len(tasks)).
    Used when marking a task as complete or deleting a task.
    Returns the index in the list (0-based).
    """
    if len(tasks) == 0:
        print("There are no tasks.")
        return None

    while True:
        try:
            number_str = input("Enter the task number to " + action_text + ": ").strip()
            number = int(number_str)
            if 1 <= number <= len(tasks):
                return number - 1  # convert to 0-based index
            else:
                print("Please enter a number between 1 and", len(tasks))
        except ValueError:
            print("Please enter a valid integer.")


# ---------------------------
# File handling
# ---------------------------

def load_tasks_from_file(filename):
    """
    Load tasks from a text file.

    File format (one task per line):
    title|due_date|priority|status
    """
    tasks = []

    try:
        with open(filename, "r") as f:
            for line in f:
                line = line.strip()
                if line == "":
                    continue  # skip empty lines

                parts = line.split("|")
                if len(parts) == 4:
                    title = parts[0]
                    due_date = parts[1]
                    priority = parts[2]
                    status = parts[3]
                    tasks.append([title, due_date, priority, status])
                else:
                    # If the line does not have exactly 4 parts, we ignore it
                    print("Warning: Ignoring invalid line in file:", line)
    except FileNotFoundError:
        # File does not exist yet -> start with empty list
        pass
    except Exception as e:
        print("Error while reading file:", e)

    return tasks


def save_tasks_to_file(tasks, filename):
    """
    Save all tasks to a text file.
    Each task becomes one line: title|due_date|priority|status
    """
    try:
        with open(filename, "w") as f:
            for task in tasks:
                title = task[0]
                due_date = task[1]
                priority = task[2]
                status = task[3]
                line = title + "|" + due_date + "|" + priority + "|" + status + "\n"
                f.write(line)
    except Exception as e:
        print("Error while saving tasks:", e)


# ---------------------------
# Task list helpers
# ---------------------------

def sort_tasks_by_due_date(tasks):
    """
    Sort the tasks list IN PLACE by due_date using a simple bubble sort
    (only basic loops and if, no advanced features).

    Tasks with 'no date' are moved to the end.
    """
    n = len(tasks)
    for i in range(n - 1):
        for j in range(0, n - 1 - i):
            date1 = tasks[j][1]
            date2 = tasks[j + 1][1]

            # Treat "no date" as very large date so it goes to the end
            if date1 == "no date":
                key1 = "9999-99-99"
            else:
                key1 = date1

            if date2 == "no date":
                key2 = "9999-99-99"
            else:
                key2 = date2

            if key1 > key2:
                # Swap tasks[j] and tasks[j+1]
                temp = tasks[j]
                tasks[j] = tasks[j + 1]
                tasks[j + 1] = temp


def print_single_task(task, index):
    """
    Print one task in a nice format.

    Example:
    1. [pending] (high) 2025-12-01 - Buy groceries
    """
    title = task[0]
    due_date = task[1]
    priority = task[2]
    status = task[3]

    # Show "no date" in a more friendly way
    if due_date == "no date":
        due_text = "no due date"
    else:
        due_text = due_date

    print(f"{index}. [{status}] ({priority}) {due_text} - {title}")


def view_all_tasks(tasks):
    """Display all tasks, sorted by due date."""
    if len(tasks) == 0:
        print("No tasks found.")
        return

    # Sort before displaying
    sort_tasks_by_due_date(tasks)

    print("\n--- ALL TASKS ---")
    for i in range(len(tasks)):
        print_single_task(tasks[i], i + 1)


def view_tasks_by_status(tasks):
    """Display only tasks with a certain status (pending or done)."""
    if len(tasks) == 0:
        print("No tasks found.")
        return

    wanted_status = get_valid_status()

    print(f"\n--- TASKS WITH STATUS: {wanted_status} ---")
    count = 0
    for i in range(len(tasks)):
        if tasks[i][3] == wanted_status:
            print_single_task(tasks[i], i + 1)
            count += 1

    if count == 0:
        print("No tasks with status:", wanted_status)


def add_task(tasks):
    """Create a new task and add it to the list."""
    print("\n--- ADD NEW TASK ---")
    title = get_non_empty_title()
    due_date = get_valid_date()
    priority = get_valid_priority()
    status = "pending"  # new tasks start as pending

    tasks.append([title, due_date, priority, status])
    print("Task added successfully.")


def mark_task_complete(tasks):
    """Mark a selected task as done."""
    if len(tasks) == 0:
        print("No tasks to mark as complete.")
        return

    print("\n--- MARK TASK AS COMPLETE ---")
    # Show all tasks with numbers
    view_all_tasks(tasks)

    index = get_valid_task_index(tasks, "mark as complete")
    if index is None:
        return

    if tasks[index][3] == "done":
        print("This task is already marked as done.")
    else:
        tasks[index][3] = "done"
        print("Task marked as complete.")


def delete_task(tasks):
    """Delete a selected task from the list."""
    if len(tasks) == 0:
        print("No tasks to delete.")
        return

    print("\n--- DELETE TASK ---")
    view_all_tasks(tasks)

    index = get_valid_task_index(tasks, "delete")
    if index is None:
        return

    # Show the task that will be deleted
    print("You are about to delete this task:")
    print_single_task(tasks[index], index + 1)

    confirm = input("Are you sure? (y/n): ").strip().lower()
    if confirm == "y":
        # Remove the task from the list
        tasks.pop(index)
        print("Task deleted.")
    else:
        print("Delete cancelled.")


# ---------------------------
# Menu and main program
# ---------------------------

def show_menu():
    """Print the main menu."""
    print("\n--- TO-DO LIST MANAGER ---")
    print("1. Add new task")
    print("2. View all tasks (sorted by due date)")
    print("3. View tasks by status (pending/done)")
    print("4. Mark task as complete")
    print("5. Delete task")
    print("6. Exit")


def main():
    filename = "tasks.txt"

    # Load existing tasks from file (if file exists)
    tasks = load_tasks_from_file(filename)

    print("Welcome to the To-Do List Manager!")

    # Main loop
    while True:
        show_menu()
        choice = input("Choose an option (1-6): ").strip()

        if choice == "1":
            add_task(tasks)
            save_tasks_to_file(tasks, filename)  # save after change
        elif choice == "2":
            view_all_tasks(tasks)
        elif choice == "3":
            view_tasks_by_status(tasks)
        elif choice == "4":
            mark_task_complete(tasks)
            save_tasks_to_file(tasks, filename)  # save after change
        elif choice == "5":
            delete_task(tasks)
            save_tasks_to_file(tasks, filename)  # save after change
        elif choice == "6":
            print("Goodbye!")
            # Save once more before exiting (optional, but safe)
            save_tasks_to_file(tasks, filename)
            break
        else:
            print("Invalid choice. Please enter a number from 1 to 6.")


# Start the program
main()
